<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Copy original episode and movie names with formatting for use in local personal media libraries">
    <title>Name Fetcher</title>
    <style>
        :root {
            --bg-color: #030712;
            --primary-text: #f9fafb;
            --secondary-text: #9ca3af;
            --tertiary-text: #4b5563;
            --panel-bg: #111827;
            --panel-hover: #1f2937;
            --border-color: #374151;
            --accent-color: #4f46e5;
            --accent-text: #a5b4fc;
            --error-text: #f87171;
            --success-text: #4ade80;
            --success-icon-color: #39ff14;
            --error-icon-color: #f87171;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            line-height: 1.6;
        }
        .container {
            width: 100%;
            max-width: 42rem;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }
        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .title-button {
            background: none;
            border: none;
            color: inherit;
            font: inherit;
            padding: 0;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            cursor: pointer;
        }
        #searchInput {
            width: 100%;
            background-color: var(--panel-bg);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 3rem 0.75rem 1rem;
            font-size: 1.125rem;
            transition: border-color 150ms ease, box-shadow 150ms ease;
        }
        #searchInput::placeholder {
            color: var(--secondary-text);
        }
        #searchInput:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        #searchInput.search-focus-flash {
            animation: search-flash 0.5s ease;
        }
        @keyframes search-flash {
            0%, 100% { box-shadow: 0 0 0 2px var(--accent-color); }
            50% { box-shadow: 0 0 0 4px var(--accent-color); }
        }
        #searchSection {
            position: relative;
        }
        .search-container {
            position: relative;
        }
        .search-adornment {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .loader {
            width: 1.5rem;
            height: 1.5rem;
            border: 4px solid var(--panel-hover);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .clear-search-btn {
            background: none;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 0.5rem;
            margin: -0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 150ms ease;
            touch-action: manipulation;
        }
        .clear-search-btn:hover {
            color: var(--primary-text);
        }
        .clear-search-btn svg {
            width: 1.25rem;
            height: 1.25rem;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        #searchResults {
            position: absolute;
            width: 100%;
            z-index: 10;
            margin-top: 0.5rem;
            max-height: 24rem;
            overflow-y: auto;
            background-color: var(--bg-color);
            border-radius: 0.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin: 0.25rem;
            background-color: var(--panel-bg);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 150ms;
            touch-action: manipulation;
        }
        .search-result-item:hover,
        .search-result-item.active {
            background-color: var(--panel-hover);
        }
        .search-result-item img,
        .details-header img {
            object-fit: cover;
            background-color: var(--panel-hover);
        }
        .poster-image {
            cursor: pointer;
            transition: transform 150ms ease;
            touch-action: manipulation;
        }
        .poster-image:hover {
            transform: scale(1.03);
        }
        .search-result-item .poster-image {
            width: 45px;
            height: 67px;
            border-radius: 0.25rem;
            margin-right: 1rem;
        }
        .search-result-item .info {
            flex-grow: 1;
        }
        .search-result-item p {
            margin: 0;
        }
        .search-result-item .title {
            font-weight: 600;
        }
        .search-result-item .meta {
            font-size: 0.875rem;
            color: var(--secondary-text);
        }
        #detailsSection {
            margin-top: 2rem;
        }
        .details-header {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }
        .details-header .poster-image {
            width: 128px;
            height: 192px;
            border-radius: 0.5rem;
            flex-shrink: 0;
        }
        .details-info {
            flex-grow: 1;
        }
        .name-block {
            margin-bottom: 1rem;
        }
        .name-block h3 {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--secondary-text);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .name-block .name-line {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        .name-block pre {
            font-family: "SF Mono", "Consolas", "Roboto Mono", "Fira Code", monospace;
            font-size: 1.125rem;
            color: var(--primary-text);
            margin-top: 0.5rem;
            padding: 0;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            flex-grow: 1;
        }
        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            margin-top: 0.25rem;
            margin-right: -0.25rem;
            border-radius: 0.25rem;
            color: var(--secondary-text);
            transition: color 150ms, background-color 150ms;
            touch-action: manipulation;
        }
        .copy-btn:hover {
            background-color: var(--panel-hover);
            color: var(--primary-text);
        }
        .copy-btn svg {
            width: 1.125rem;
            height: 1.125rem;
            display: block;
        }
        .copy-btn.copied svg {
            color: var(--success-icon-color);
        }
        .copy-btn.error svg {
            color: var(--error-icon-color);
        }
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: var(--panel-bg);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            flex-grow: 1;
            transition: border-color 150ms ease, box-shadow 150ms ease;
        }
        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        .season-controls {
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .copy-all-btn {
            background-color: var(--panel-bg);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 150ms, color 150ms;
            flex-shrink: 0;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            touch-action: manipulation;
        }
        .copy-all-btn .btn-text {
            transition: color 150ms;
        }
        .copy-all-btn:hover,
        .copy-all-btn.dropdown-open {
            background-color: var(--panel-hover);
        }
        .copy-all-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .copy-all-btn svg {
            width: 1.125rem;
            height: 1.125rem;
            transition: transform 150ms ease;
        }
        .copy-all-btn.copied svg {
            color: var(--success-icon-color);
        }
        .copy-all-btn.error svg {
            color: var(--error-icon-color);
        }
        .copy-container {
            position: relative;
        }
        .copy-options {
            position: absolute;
            top: calc(100% + 0.25rem);
            right: 0;
            background-color: var(--panel-hover);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            z-index: 10;
            min-width: 12rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .copy-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: var(--primary-text);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            touch-action: manipulation;
        }
        .copy-option:hover,
        .copy-option:focus {
            background-color: var(--accent-color);
            outline: none;
        }
        .copy-option-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 0.5rem 0;
        }
        .copy-option-submenu-container {
            position: relative;
        }
        .copy-option .submenu-arrow {
            width: 1rem;
            height: 1rem;
            color: var(--secondary-text);
        }
        .copy-options-level2 {
            position: absolute;
            top: -1px;
            left: 100%;
            display: none;
            background-color: var(--panel-hover);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            z-index: 11;
            min-width: 8rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .copy-option-submenu-container:hover > .copy-options-level2,
        .copy-option-submenu-container:focus-within > .copy-options-level2,
        .copy-option-submenu-container.submenu-open > .copy-options-level2 {
            display: block;
        }
        .episode-list {
            outline: none;
            margin-top: 1rem;
        }
        .episode-list .episode-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.75rem 0;
            border-top: 1px solid var(--panel-bg);
        }
        .episode-list .episode-item:first-child {
            border-top: none;
        }
        .episode-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        .episode-list .episode-content {
            flex-grow: 1;
        }
        .episode-list .episode-meta {
            color: var(--secondary-text);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .episode-list pre {
            font-family: "SF Mono", "Consolas", "Roboto Mono", "Fira Code", monospace;
            color: var(--primary-text);
            margin-top: 0.25rem;
            font-size: 1rem;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        [hidden] {
            display: none !important;
        }
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .error-message {
            color: var(--error-text);
            text-align: center;
            padding: 1rem;
            background-color: rgba(248, 113, 113, 0.1);
            border-radius: 0.5rem;
        }
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--secondary-text);
        }
        .empty-state svg {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 0.5rem;
            color: var(--border-color);
        }
        ::-webkit-scrollbar {
            width: 0.5rem;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--panel-hover);
            border-radius: 0.25rem;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }
        @media (max-width: 640px) {
            .container {
                padding: 1rem;
            }
            .title-button {
                font-size: 1.75rem;
            }
            #searchInput {
                font-size: 1rem;
            }
            .details-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .details-header img {
                width: 192px;
                height: 288px;
            }
            .season-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .copy-all-btn {
                margin-top: 0.5rem;
            }
            .copy-options-level2 {
                left: auto;
                right: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button type="button" id="title-button" class="title-button">Name Fetcher</button>
        </header>
        <main id="mainContent">
            <div id="searchSection">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search for a Movie or TV Show..." aria-label="Search for a Movie or TV Show" autocomplete="off" aria-controls="searchResults" aria-autocomplete="list" autofocus>
                    <div class="search-adornment">
                        <button type="button" id="clearSearchBtn" class="clear-search-btn" aria-label="Clear search" hidden>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <div id="main-loader" class="loader" hidden></div>
                    </div>
                </div>
                <div id="searchResults" role="listbox" aria-label="Search Results" hidden></div>
                <div id="a11y-announcer" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>
            </div>
            <div id="detailsSection">
                <div class="empty-state" id="welcome-message">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9A2.25 2.25 0 004.5 18.75z" />
                    </svg>
                    <p style="font-weight: 600;">Ready to Organize Your Media Collection?</p>
                    <p style="font-size: 0.875rem; color: var(--tertiary-text); margin-top: 0.25rem;">Start by Searching for a Movie or TV Show.</p>
                </div>
            </div>
        </main>
    </div>
    <script>
        (() => {
            const CONFIG = {
                apiKey: "c674a42c1610c3dc031b925860214289",
                debounceDelay: 200,
                imgBaseUrl: 'https://image.tmdb.org/t/p/',
                imageSizes: {
                    thumbnail: 'w92',
                    poster: 'w342',
                    original: 'original'
                },
                mediaTypes: {
                    movie: 'movie',
                    tv: 'tv',
                },
                copyTypes: {
                    names: 'names',
                    rename: 'rename'
                },
                placeholderImg: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2 3' fill='%231f2937'%3E%3Crect width='2' height='3'/%3E%3C/svg%3E"
            };
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const detailsSection = document.getElementById('detailsSection');
            const mainLoader = document.getElementById('main-loader');
            const titleButton = document.getElementById('title-button');
            const announcer = document.getElementById('a11y-announcer');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const state = {
                debounceTimer: null,
                currentKeyboardFocus: -1
            };
            let searchResultNodes = [];
            const copyIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a2.25 2.25 0 01-2.25 2.25H9.75A2.25 2.25 0 017.5 4.5v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>`;
            const checkIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
            const errorIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
            const fetchData = async(url) => {
                mainLoader.hidden = false;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    return await response.json();
                } catch (error) {
                    console.error("Fetch failed:", error);
                    return {
                        error: "Failed to fetch data. Please check your connection or try again later."
                    };
                } finally {
                    mainLoader.hidden = true;
                }
            };
            const clearAndDisplayError = (container, message) => {
                container.innerHTML = `<div class="error-message">${message}</div>`;
            };
            const searchMedia = (query) => {
                if (!query) return clearSearchResults();
                const url = `https://api.themoviedb.org/3/search/multi?api_key=${CONFIG.apiKey}&query=${encodeURIComponent(query)}`;
                fetchData(url).then(data => {
                    if (data.error) return clearAndDisplayError(searchResults, data.error);
                    if (data && data.results) displaySearchResults(data.results);
                });
            };
            const getMediaDetails = (id, type) => {
                clearSearchResults();
                detailsSection.innerHTML = '';
                const url = `https://api.themoviedb.org/3/${type}/${id}?api_key=${CONFIG.apiKey}`;
                fetchData(url).then(data => {
                    if (data.error) return clearAndDisplayError(detailsSection, data.error);
                    if (data) {
                        if (type === CONFIG.mediaTypes.movie) {
                            displayMovieDetails(data);
                            detailsSection.querySelector('.copy-btn')?.focus();
                        } else {
                            displayTvShowDetails(data);
                            detailsSection.querySelector('#season-select')?.focus();
                        }
                    }
                });
            };
            const getSeasonDetails = (tvId, seasonNumber) => {
                const url = `https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${CONFIG.apiKey}`;
                const episodeListContainer = document.querySelector('.episode-list');
                const copyAllBtn = document.getElementById('copy-all-toggle-btn');
                const seasonSelect = document.getElementById('season-select');
                if (episodeListContainer) episodeListContainer.innerHTML = `<div class="episode-loader"><div class="loader"></div></div>`;
                if (copyAllBtn) copyAllBtn.disabled = true;
                fetchData(url).then(data => {
                    if (data.error) return clearAndDisplayError(episodeListContainer, data.error);
                    if (data && data.episodes && episodeListContainer) {
                        displayEpisodes(data.episodes);
                        updateCopyAllData(data.episodes);
                        const selectedSeasonName = seasonSelect.options[seasonSelect.selectedIndex].text;
                        announcer.textContent = `Loaded ${data.episodes.length} episodes for ${selectedSeasonName}.`;
                    }
                });
            };
            const sanitizeText = (text) => {
                const temp = document.createElement('div');
                temp.textContent = text || '';
                return temp.innerHTML;
            };
            const closeSearchOnClickOutside = (e) => {
                if (!searchResults.hidden && !searchResults.contains(e.target) && e.target !== searchInput) {
                    clearSearchResults();
                }
            };
            const clearSearchResults = () => {
                searchResults.innerHTML = '';
                searchResults.hidden = true;
                state.currentKeyboardFocus = -1;
                searchResultNodes = [];
                searchInput.removeAttribute('aria-activedescendant');
                document.removeEventListener('click', closeSearchOnClickOutside);
            };
            const displaySearchResults = (results) => {
                clearSearchResults();
                const filteredResults = results.filter(r => r.media_type === CONFIG.mediaTypes.movie || r.media_type === CONFIG.mediaTypes.tv);
                if (filteredResults.length === 0) {
                    searchResults.innerHTML = `
                        <div class="empty-state">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                            </svg>
                            <p style="font-weight: 600;">No results found</p>
                            <p style="font-size: 0.875rem; color: var(--tertiary-text); margin-top: 0.25rem;">We couldn't find anything for your search.</p>
                        </div>`;
                    announcer.textContent = 'No results found.';
                } else {
                    const fragment = document.createDocumentFragment();
                    filteredResults.forEach((result, index) => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.dataset.id = result.id;
                        item.dataset.type = result.media_type;
                        item.id = `result-option-${index}`;
                        item.setAttribute('role', 'option');
                        const year = result.release_date?.split('-')[0] || result.first_air_date?.split('-')[0] || 'N/A';
                        const title = result.title || result.name;
                        const posterUrl = result.poster_path ? `${CONFIG.imgBaseUrl}${CONFIG.imageSizes.thumbnail}${result.poster_path}` : CONFIG.placeholderImg;
                        item.innerHTML = `
                            <img class="poster-image" data-poster-path="${result.poster_path}" src="${posterUrl}" alt="Poster for ${sanitizeText(title)}" loading="lazy" onerror="this.onerror=null;this.src='${CONFIG.placeholderImg}';">
                            <div class="info">
                                <p class="title">${sanitizeText(title)}</p>
                                <p class="meta">${year} &bull; ${result.media_type.toUpperCase()}</p>
                            </div>`;
                        fragment.appendChild(item);
                    });
                    searchResults.appendChild(fragment);
                    searchResultNodes = searchResults.querySelectorAll('.search-result-item');
                    announcer.textContent = `${filteredResults.length} results found. Use arrow keys to navigate.`;
                    document.addEventListener('click', closeSearchOnClickOutside);
                }
                searchResults.hidden = false;
            };
            const createNameBlock = (title, name) => `
                <div class="name-block">
                    <h3>${title}</h3>
                    <div class="name-line">
                        <pre>${sanitizeText(name)}</pre>
                        <button class="copy-btn" data-copy-text="${sanitizeText(name)}" aria-label="Copy ${title}">${copyIconSVG}</button>
                    </div>
                </div>`;
            const displayMovieDetails = (movie) => {
                const posterUrl = movie.poster_path ? `${CONFIG.imgBaseUrl}${CONFIG.imageSizes.poster}${movie.poster_path}` : CONFIG.placeholderImg;
                detailsSection.innerHTML = `
                    <div class="details-header">
                        <img class="poster-image" data-poster-path="${movie.poster_path}" src="${posterUrl}" alt="Poster for ${sanitizeText(movie.original_title)}" onerror="this.onerror=null;this.src='${CONFIG.placeholderImg}';">
                        <div class="details-info">
                            ${createNameBlock('Title', movie.original_title)}
                        </div>
                    </div>`;
            };
            const displayTvShowDetails = (tvShow) => {
                const posterUrl = tvShow.poster_path ? `${CONFIG.imgBaseUrl}${CONFIG.imageSizes.poster}${tvShow.poster_path}` : CONFIG.placeholderImg;
                const sortedSeasons = tvShow.seasons.sort((a, b) => a.season_number - b.season_number);
                const seasonOptions = sortedSeasons.map(season => `<option value="${season.season_number}">${sanitizeText(season.name)}</option>`).join('');
                detailsSection.innerHTML = `
                    <div class="details-header">
                        <img class="poster-image" data-poster-path="${tvShow.poster_path}" src="${posterUrl}" alt="Poster for ${sanitizeText(tvShow.original_name)}" onerror="this.onerror=null;this.src='${CONFIG.placeholderImg}';">
                        <div class="details-info">
                           ${createNameBlock('Title', tvShow.original_name)}
                        </div>
                    </div>
                    <div class="season-controls">
                        <label for="season-select" class="visually-hidden">Select a Season</label>
                        <select id="season-select" data-tv-id="${tvShow.id}" aria-label="Select a season">${seasonOptions}</select>
                        <div class="copy-container">
                            <button id="copy-all-toggle-btn" class="copy-all-btn" disabled><span class="btn-text">Copy All</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 011.06 0L10 11.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 9.28a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg></button>
                            <div id="copy-options" class="copy-options" hidden>
                                <button class="copy-option" data-copy-type="names"><span>Names Only</span></button>
                                <div class="copy-option-submenu-container">
                                    <button class="copy-option" aria-haspopup="true" aria-expanded="false">
                                        <span>Bulk Rename</span>
                                        <svg class="submenu-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div class="copy-options-level2">
                                        <button class="copy-option" data-copy-type="rename" data-extension="mkv"><span>.mkv</span></button>
                                        <button class="copy-option" data-copy-type="rename" data-extension="mp4"><span>.mp4</span></button>
                                        <button class="copy-option" data-copy-type="rename" data-extension="mov"><span>.mov</span></button>
                                        <button class="copy-option" data-copy-type="rename" data-extension="avi"><span>.avi</span></button>
                                        <button class="copy-option" data-copy-type="rename" data-extension="wmv"><span>.wmv</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="episode-list" tabindex="-1"></div>`;
                if (sortedSeasons.length > 0) getSeasonDetails(tvShow.id, sortedSeasons[0].season_number);
            };
            const displayEpisodes = (episodes) => {
                const episodeListContainer = document.querySelector('.episode-list');
                if (!episodeListContainer) return;
                episodeListContainer.innerHTML = '';
                if (episodes.length === 0) {
                    episodeListContainer.innerHTML = `<p style="color: var(--secondary-text); text-align: center; padding: 1rem;">No episode data available for this season.</p>`;
                    return;
                }
                const fragment = document.createDocumentFragment();
                episodes.forEach(episode => {
                    const item = document.createElement('div');
                    item.className = 'episode-item';
                    item.innerHTML = `
                        <div class="episode-content">
                            <p class="episode-meta">EPISODE ${episode.episode_number}</p>
                            <pre>${sanitizeText(episode.name)}</pre>
                        </div>
                        <button class="copy-btn" data-copy-text="${sanitizeText(episode.name)}" aria-label="Copy episode name">${copyIconSVG}</button>`;
                    fragment.appendChild(item);
                });
                episodeListContainer.appendChild(fragment);
            };
            const updateCopyAllData = (episodes) => {
                const copyAllBtn = document.getElementById('copy-all-toggle-btn');
                const copyContainer = document.querySelector('.copy-container');
                if (!copyAllBtn || !copyContainer || episodes.length === 0) return;
                const namesOnly = episodes.map(e => e.name).join('\n');
                const relevantEpisodeData = episodes.map(e => ({
                    name: e.name,
                    episode_number: e.episode_number
                }));
                copyContainer.dataset.episodesJson = JSON.stringify(relevantEpisodeData);
                copyContainer.dataset.copyNames = namesOnly;
                copyAllBtn.disabled = false;
            };
            const handleCopyClick = async(btn, textToCopy) => {
                if (!textToCopy || btn.disabled) return;
                const originalContentHTML = btn.innerHTML;
                const feedbackDuration = 1200;
                const performCopy = async() => {
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        return true;
                    } catch (err) {
                        try {
                            const textArea = document.createElement("textarea");
                            textArea.value = textToCopy;
                            textArea.style.position = "fixed";
                            textArea.style.left = "-9999px";
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            const success = document.execCommand('copy');
                            document.body.removeChild(textArea);
                            if (!success) throw new Error('Fallback copy failed');
                            return true;
                        } catch (fallbackErr) {
                            console.error('All copy methods failed:', fallbackErr);
                            return false;
                        }
                    }
                };
                btn.disabled = true;
                const wasCopied = await performCopy();
                if (wasCopied) {
                    btn.innerHTML = checkIconSVG;
                    btn.classList.add('copied');
                } else {
                    btn.innerHTML = errorIconSVG;
                    btn.classList.add('error');
                }
                setTimeout(() => {
                    btn.innerHTML = originalContentHTML;
                    btn.classList.remove('copied', 'error');
                    btn.disabled = false;
                }, feedbackDuration);
            };
            const openPosterInNewTab = (posterPath) => {
                if (!posterPath || posterPath === 'null') return;
                const highQualityUrl = `${CONFIG.imgBaseUrl}${CONFIG.imageSizes.original}${posterPath}`;
                window.open(highQualityUrl, '_blank');
            };
            const toTitleCase = (str) => {
                if (!str) return '';
                const minorWords = new Set(['a', 'an', 'the', 'and', 'but', 'or', 'nor', 'for', 'so', 'yet', 'as', 'at', 'by', 'in', 'of', 'off', 'on', 'to', 'up']);
                const capitalize = (word) => {
                    if (word.length > 1 && word.toUpperCase() === word) {
                        return word;
                    }
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                };
                const words = str.split(' ');
                return words.map((word, index) => {
                    if (word === "") return "";
                    const lowerWord = word.toLowerCase();
                    if (index === 0 || index === words.length - 1) {
                        return capitalize(word);
                    }
                    if (index > 0 && words[index - 1].endsWith(':')) {
                        return capitalize(word);
                    }
                    if (word.includes('-')) {
                        return word.split('-').map((part, partIndex) => {
                            if (partIndex === 0) return capitalize(part);
                            if (minorWords.has(part.toLowerCase())) return part.toLowerCase();
                            return capitalize(part);
                        }).join('-');
                    }
                    if (minorWords.has(lowerWord)) {
                        return lowerWord;
                    }
                    return capitalize(word);
                }).join(' ');
            };
            const handleCopyOptionsKeydown = (e) => {
                const activeElement = document.activeElement;
                if (!activeElement.classList.contains('copy-option')) return;
                const currentMenu = activeElement.closest('.copy-options, .copy-options-level2');
                if (!currentMenu) return;
                const options = Array.from(currentMenu.querySelectorAll(':scope > .copy-option, :scope > .copy-option-submenu-container > .copy-option'));
                const currentIndex = options.indexOf(activeElement);
                switch (e.key) {
                    case 'ArrowUp':
                    case 'ArrowDown':
                        e.preventDefault();
                        const direction = e.key === 'ArrowDown' ? 1 : -1;
                        const nextIndex = (currentIndex + direction + options.length) % options.length;
                        options[nextIndex]?.focus();
                        break;
                    case 'ArrowRight':
                        if (activeElement.parentElement.classList.contains('copy-option-submenu-container')) {
                            e.preventDefault();
                            const submenu = activeElement.nextElementSibling;
                            submenu.querySelector('.copy-option')?.focus();
                        }
                        break;
                    case 'ArrowLeft':
                        if (currentMenu.classList.contains('copy-options-level2')) {
                            e.preventDefault();
                            currentMenu.parentElement.querySelector('.copy-option')?.focus();
                        }
                        break;
                    case 'Enter':
                        if (!activeElement.parentElement.classList.contains('copy-option-submenu-container')) {
                            activeElement.click();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        if (currentMenu.classList.contains('copy-options-level2')) {
                            currentMenu.parentElement.querySelector('.copy-option')?.focus();
                        } else {
                            document.getElementById('copy-options').hidden = true;
                            document.getElementById('copy-all-toggle-btn')?.focus();
                        }
                        break;
                }
            };
            searchInput.addEventListener('input', () => {
                const originalValue = searchInput.value;
                const cursorPosition = searchInput.selectionStart;
                const titleCasedValue = toTitleCase(originalValue);
                if (originalValue !== titleCasedValue) {
                    searchInput.value = titleCasedValue;
                    searchInput.setSelectionRange(cursorPosition, cursorPosition);
                }
                clearTimeout(state.debounceTimer);
                clearSearchBtn.hidden = searchInput.value.length === 0;
                if (searchInput.value.length === 0) {
                    clearSearchResults();
                    return;
                }
                state.debounceTimer = setTimeout(() => {
                    searchMedia(searchInput.value.trim());
                }, CONFIG.debounceDelay);
            });
            searchInput.addEventListener('keydown', (e) => {
                if (searchResults.hidden) return;
                if (e.key === 'Escape') return clearSearchResults();
                if (searchResultNodes.length === 0) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    state.currentKeyboardFocus = (state.currentKeyboardFocus + 1) % searchResultNodes.length;
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    state.currentKeyboardFocus = (state.currentKeyboardFocus - 1 + searchResultNodes.length) % searchResultNodes.length;
                } else if (e.key === 'Enter' && state.currentKeyboardFocus > -1) {
                    e.preventDefault();
                    searchResultNodes[state.currentKeyboardFocus].click();
                    return;
                } else {
                    return;
                }
                setActiveResult();
            });
            const setActiveResult = () => {
                searchResultNodes.forEach((item, index) => {
                    if (index === state.currentKeyboardFocus) {
                        item.classList.add('active');
                        item.scrollIntoView({
                            block: 'nearest'
                        });
                        searchInput.setAttribute('aria-activedescendant', item.id);
                    } else {
                        item.classList.remove('active');
                    }
                });
            };
            searchResults.addEventListener('click', (e) => {
                const poster = e.target.closest('.poster-image');
                if (poster) {
                    e.stopPropagation();
                    openPosterInNewTab(poster.dataset.posterPath);
                    return;
                }
                const item = e.target.closest('.search-result-item');
                if (item) getMediaDetails(item.dataset.id, item.dataset.type);
            });
            detailsSection.addEventListener('click', (e) => {
                const target = e.target;
                const poster = target.closest('.poster-image');
                if (poster) return openPosterInNewTab(poster.dataset.posterPath);
                const copyBtn = target.closest('.copy-btn');
                if (copyBtn) {
                    return handleCopyClick(copyBtn, copyBtn.dataset.copyText);
                }
                const toggleBtn = target.closest('#copy-all-toggle-btn');
                if (toggleBtn) {
                    const copyOptions = document.getElementById('copy-options');
                    if (toggleBtn.classList.contains('copied') || toggleBtn.classList.contains('error')) return;
                    const isHidden = copyOptions.hidden;
                    const closeMenu = () => {
                        const submenuContainer = copyOptions.querySelector('.submenu-open');
                        if (submenuContainer) {
                           submenuContainer.classList.remove('submenu-open');
                           submenuContainer.querySelector('[aria-haspopup]').setAttribute('aria-expanded', 'false');
                        }
                        copyOptions.hidden = true;
                        toggleBtn.classList.remove('dropdown-open');
                        document.removeEventListener('click', handleOutsideClick);
                        copyOptions.removeEventListener('keydown', handleCopyOptionsKeydown);
                    };
                    const handleOutsideClick = (event) => {
                        if (!toggleBtn.parentElement.contains(event.target)) {
                            closeMenu();
                        }
                    };
                    if (isHidden) {
                        copyOptions.hidden = false;
                        toggleBtn.classList.add('dropdown-open');
                        copyOptions.addEventListener('keydown', handleCopyOptionsKeydown);
                        setTimeout(() => document.addEventListener('click', handleOutsideClick), 0);
                    } else {
                        closeMenu();
                    }
                    return;
                }
                const copyOptionBtn = target.closest('.copy-option');
                if (copyOptionBtn) {
                    if (copyOptionBtn.hasAttribute('aria-haspopup')) {
                        e.preventDefault();
                        const submenuContainer = copyOptionBtn.parentElement;
                        const isExpanded = submenuContainer.classList.toggle('submenu-open');
                        copyOptionBtn.setAttribute('aria-expanded', isExpanded);
                        return;
                    }
                    const copyContainer = target.closest('.copy-container');
                    const copyType = copyOptionBtn.dataset.copyType;
                    let textToCopy;
                    if (copyType === CONFIG.copyTypes.names) {
                        textToCopy = copyContainer.dataset.copyNames;
                    } else if (copyType === CONFIG.copyTypes.rename) {
                        const extension = copyOptionBtn.dataset.extension;
                        const episodes = JSON.parse(copyContainer.dataset.episodesJson);
                        textToCopy = episodes.map(e => `E${String(e.episode_number).padStart(2, '0')} - ${e.name}.${extension}`).join('\n');
                    }
                    if (textToCopy) {
                        document.getElementById('copy-options').hidden = true;
                        document.getElementById('copy-all-toggle-btn').classList.remove('dropdown-open');
                        handleCopyClick(document.getElementById('copy-all-toggle-btn'), textToCopy);
                    }
                }
            });
            detailsSection.addEventListener('change', (e) => {
                if (e.target.id === 'season-select') {
                    getSeasonDetails(e.target.dataset.tvId, e.target.value);
                }
            });
            const clearSearchInput = () => {
                searchInput.value = '';
                clearSearchResults();
                announcer.textContent = 'Search input cleared.';
                clearSearchBtn.hidden = true;
                searchInput.focus();
            };
            const resetApp = () => {
                clearSearchInput();
                detailsSection.innerHTML = `<div class="empty-state" id="welcome-message">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9A2.25 2.25 0 004.5 18.75z" />
                    </svg>
                    <p style="font-weight: 600;">Ready to Organize Your Media Collection?</p>
                    <p style="font-size: 0.875rem; color: var(--tertiary-text); margin-top: 0.25rem;">Start by Searching for a Movie or TV Show.</p>
                </div>`;
            };
            clearSearchBtn.addEventListener('click', clearSearchInput);
            titleButton.addEventListener('click', resetApp);
            window.addEventListener('keydown', (e) => {
                if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault();
                    searchInput.classList.add('search-focus-flash');
                    searchInput.focus();
                    setTimeout(() => {
                        searchInput.classList.remove('search-focus-flash');
                    }, 500);
                }
            });
            searchInput.focus();
        })();
    </script>
</body>
</html>

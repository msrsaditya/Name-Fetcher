<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Copy original episode and movie names with formatting for use in local personal media libraries">
    <title>The Media Library</title>
    <style>
        :root {
            --bg-color: #030712;
            --primary-text: #f9fafb;
            --secondary-text: #9ca3af;
            --tertiary-text: #4b5563;
            --panel-bg: #111827;
            --panel-hover: #1f2937;
            --border-color: #374151;
            --accent-color: #4f46e5;
            --accent-text: #a5b4fc;
            --error-text: #f87171;
            --success-text: #4ade80;
            --success-icon-color: #39ff14;
            --error-icon-color: #f87171;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            line-height: 1.6;
        }
        .container {
            width: 100%;
            max-width: 42rem;
            margin: 0 auto;
            padding: 1.5rem 1rem;
        }
        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .title-button {
            background: none;
            border: none;
            color: inherit;
            font: inherit;
            padding: 0;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            cursor: pointer;
        }
        #searchInput {
            width: 100%;
            background-color: var(--panel-bg);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 3rem 0.75rem 1rem;
            font-size: 1.125rem;
            transition: border-color 150ms ease, box-shadow 150ms ease;
        }
        #searchInput::placeholder {
            color: var(--secondary-text);
        }
        #searchInput:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        #searchInput.search-focus-flash {
            animation: search-flash 0.5s ease;
        }
        @keyframes search-flash {
            0%,
            100% {
                box-shadow: 0 0 0 2px var(--accent-color);
            }
            50% {
                box-shadow: 0 0 0 4px var(--accent-color);
            }
        }
        #searchSection {
            position: relative;
        }
        .search-container {
            position: relative;
        }
        .search-adornment {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .loader {
            width: 1.5rem;
            height: 1.5rem;
            border: 4px solid var(--panel-hover);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .clear-search-btn {
            background: none;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 0.5rem;
            margin: -0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 150ms ease;
            touch-action: manipulation;
        }
        .clear-search-btn:hover {
            color: var(--primary-text);
        }
        .clear-search-btn svg {
            width: 1.25rem;
            height: 1.25rem;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        #searchResults {
            position: absolute;
            width: 100%;
            z-index: 10;
            margin-top: 0.5rem;
            max-height: 24rem;
            overflow-y: auto;
            background-color: var(--bg-color);
            border-radius: 0.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }
        .search-result-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin: 0.25rem;
            background-color: var(--panel-bg);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 150ms;
            touch-action: manipulation;
        }
        .search-result-item:hover,
        .search-result-item.active {
            background-color: var(--panel-hover);
        }
        .poster-image {
            object-fit: cover;
            background-color: var(--panel-hover);
            cursor: pointer;
            display: block;
        }
        .poster-container {
            position: relative;
            flex-shrink: 0;
            cursor: pointer;
            border-radius: inherit;
            overflow: hidden;
            transition: transform 150ms ease;
        }
        .poster-container:hover {
            transform: scale(1.03);
        }
        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 150ms ease;
            pointer-events: none;
        }
        .poster-container:hover .play-overlay {
            opacity: 1;
            pointer-events: auto;
        }
        .play-trailer-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
        }
        .play-trailer-btn svg {
            width: 2.5rem;
            height: 2.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            transition: transform 150ms ease, color 150ms ease;
        }
        .play-trailer-btn:hover svg {
            transform: scale(1.1);
            color: white;
        }
        .search-result-item .poster-container {
            width: 45px;
            height: 67px;
            border-radius: 0.25rem;
            margin-right: 1rem;
        }
        .search-result-item .poster-image {
            width: 100%;
            height: 100%;
        }
        .search-result-item .info {
            flex-grow: 1;
        }
        .search-result-item p {
            margin: 0;
        }
        .search-result-item .title {
            font-weight: 600;
        }
        .search-result-item .meta {
            font-size: 0.875rem;
            color: var(--secondary-text);
        }
        #detailsSection {
            margin-top: 2rem;
        }
        .details-header {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }
        .details-header .poster-container {
            width: 150px;
            height: 225px;
            border-radius: 0.5rem;
        }
        .details-header .poster-image {
            width: 100%;
            height: 100%;
        }
        .details-info {
            flex-grow: 1;
        }
        .details-overview {
            margin-top: 1.5rem;
            color: var(--secondary-text);
            font-size: 0.95rem;
            line-height: 1.7;
        }
        .about-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .about-section h2 {
            font-size: 1.25rem;
            margin-bottom: 1.25rem;
        }
        .about-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.25rem;
        }
        .about-grid>div {
            display: flex;
            flex-direction: column;
        }
        .about-grid strong {
            font-weight: 600;
            color: var(--secondary-text);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        .about-grid span {
            font-size: 0.9rem;
        }
        .name-block {
            margin-bottom: 0.5rem;
        }
        .name-block .name-line {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .name-block pre {
            font-family: "SF Mono", "Consolas", "Roboto Mono", "Fira Code", monospace;
            font-size: 1.125rem;
            color: var(--primary-text);
            margin-top: 0;
            padding: 0;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
            flex-grow: 1;
        }
        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            margin-top: 0;
            margin-right: -0.25rem;
            border-radius: 0.25rem;
            color: var(--secondary-text);
            transition: color 150ms, background-color 150ms;
            touch-action: manipulation;
        }
        .copy-btn:hover {
            background-color: var(--panel-hover);
            color: var(--primary-text);
        }
        .copy-btn svg {
            width: 1.125rem;
            height: 1.125rem;
            display: block;
        }
        .copy-btn.copied svg {
            color: var(--success-icon-color);
        }
        .copy-btn.error svg {
            color: var(--error-icon-color);
        }
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: var(--panel-bg);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            flex-grow: 1;
            transition: border-color 150ms ease, box-shadow 150ms ease;
        }
        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color);
        }
        .season-controls {
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .copy-all-btn {
            background-color: var(--panel-bg);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 150ms, color 150ms;
            flex-shrink: 0;
            min-width: 100px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.25rem;
            touch-action: manipulation;
        }
        .copy-all-btn .btn-text {
            transition: color 150ms;
        }
        .copy-all-btn:hover,
        .copy-all-btn.dropdown-open {
            background-color: var(--panel-hover);
        }
        .copy-all-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .copy-all-btn svg {
            width: 1.125rem;
            height: 1.125rem;
            transition: transform 200ms ease;
        }
        .copy-all-btn.dropdown-open svg {
            transform: rotate(180deg);
        }
        .copy-all-btn.copied svg {
            color: var(--success-icon-color);
        }
        .copy-all-btn.error svg {
            color: var(--error-icon-color);
        }
        .copy-container {
            position: relative;
        }
        .copy-options {
            position: absolute;
            top: calc(100% + 0.25rem);
            right: 0;
            background-color: var(--panel-hover);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            z-index: 10;
            min-width: 12rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .copy-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
            color: var(--primary-text);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            touch-action: manipulation;
        }
        .copy-option:hover,
        .copy-option:focus {
            background-color: var(--accent-color);
            outline: none;
        }
        .copy-option-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 0.5rem 0;
        }
        .copy-option-submenu-container {
            position: relative;
        }
        .copy-option .submenu-arrow {
            width: 1rem;
            height: 1rem;
            color: var(--secondary-text);
            transition: transform 200ms ease;
        }
        .copy-option-submenu-container.submenu-open>.copy-option .submenu-arrow {
            transform: rotate(90deg);
        }
        .copy-options-level2 {
            position: absolute;
            top: -1px;
            left: 100%;
            display: none;
            background-color: var(--panel-hover);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            z-index: 11;
            min-width: 8rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .copy-option-submenu-container:hover>.copy-options-level2,
        .copy-option-submenu-container:focus-within>.copy-options-level2,
        .copy-option-submenu-container.submenu-open>.copy-options-level2 {
            display: block;
        }
        .episode-list {
            outline: none;
            margin-top: 1rem;
        }
        .episode-list .episode-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.75rem 0;
            border-top: 1px solid var(--panel-bg);
        }
        .episode-list .episode-item:first-child {
            border-top: none;
        }
        .episode-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        .episode-list .episode-content {
            flex-grow: 1;
        }
        .episode-list .episode-meta {
            color: var(--secondary-text);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .episode-list pre {
            font-family: "SF Mono", "Consolas", "Roboto Mono", "Fira Code", monospace;
            color: var(--primary-text);
            margin-top: 0.25rem;
            font-size: 1rem;
            white-space: pre-wrap;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        #download-section {
            position: relative;
            margin-top: 2rem;
        }
        #download-toggle-btn {
            width: 100%;
            background-color: var(--panel-bg);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 150ms, color 150ms;
            display: flex;
            align-items: center;
            justify-content: space-between;
            touch-action: manipulation;
        }
        #download-toggle-btn:hover,
        #download-toggle-btn.dropdown-open {
            background-color: var(--panel-hover);
        }
        #download-toggle-btn svg {
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 200ms ease;
        }
        #download-toggle-btn.dropdown-open svg {
            transform: rotate(180deg);
        }
        #download-options {
            position: absolute;
            bottom: calc(100% + 0.25rem);
            left: 0;
            right: 0;
            background-color: var(--panel-hover);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            z-index: 20;
            box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1), 0 -2px 4px -2px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }
        .download-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.5rem 0.5rem 1.25rem;
            font-size: 0.9rem;
            transition: background-color 150ms;
        }
        .download-option:hover {
            background-color: var(--accent-color);
        }
        .download-option a {
            color: var(--primary-text);
            text-decoration: none;
            flex-grow: 1;
        }
        .download-option .copy-btn {
            margin-top: 0;
            margin-right: 0;
        }
        [hidden] {
            display: none !important;
        }
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .error-message {
            color: var(--error-text);
            text-align: center;
            padding: 1rem;
            background-color: rgba(248, 113, 113, 0.1);
            border-radius: 0.5rem;
        }
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--secondary-text);
        }
        .empty-state svg {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 0.5rem;
            color: var(--border-color);
        }
        ::-webkit-scrollbar {
            width: 0.5rem;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--panel-hover);
            border-radius: 0.25rem;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }
        #trailer-modal,
        #poster-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 200ms ease, visibility 200ms ease;
            backdrop-filter: blur(8px);
        }
        #poster-modal {
            z-index: 35;
            padding: 1rem;
        }
        #trailer-modal.visible,
        #poster-modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .trailer-container,
        .poster-modal-content {
            position: relative;
            transform: scale(0.95);
            transition: transform 200ms ease;
        }
        .trailer-container {
            width: 90%;
            max-width: 960px;
            aspect-ratio: 16 / 9;
        }
        .poster-modal-content {
            max-width: 90vw;
            max-height: 90vh;
        }
        #trailer-modal.visible .trailer-container,
        #poster-modal.visible .poster-modal-content {
            transform: scale(1);
        }
        .trailer-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0.5rem;
        }
        #full-poster-img {
            display: block;
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        #close-trailer-btn,
        #close-poster-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            border-radius: 9999px;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 150ms ease;
        }
        #close-trailer-btn:hover,
        #close-poster-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        #close-trailer-btn svg,
        #close-poster-btn svg {
            width: 1.5rem;
            height: 1.5rem;
        }
        #toast-notification {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translate(-50%, 200%);
            background-color: var(--panel-bg);
            color: var(--primary-text);
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            z-index: 40;
            font-size: 0.875rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: transform 300ms ease-in-out;
        }
        #toast-notification.visible {
            transform: translate(-50%, 0);
        }
        @media (max-width: 640px) {
            .container {
                padding: 1.5rem 0.75rem;
            }
            .title-button {
                font-size: 1.75rem;
            }
            #searchInput {
                font-size: 1rem;
            }
            .details-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .details-header .poster-container {
                width: 192px;
                height: 288px;
            }
            .season-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .copy-all-btn {
                margin-top: 0.5rem;
            }
            .copy-options-level2 {
                left: auto;
                right: 100%;
            }
            .about-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button type="button" id="title-button" class="title-button">The Media Library</button>
        </header>
        <main id="mainContent">
            <div id="searchSection">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search for a Movie or TV Show..." aria-label="Search for a Movie or TV Show" autocomplete="off" aria-controls="searchResults" aria-autocomplete="list" autofocus>
                    <div class="search-adornment">
                        <button type="button" id="clearSearchBtn" class="clear-search-btn" aria-label="Clear search" hidden>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <div id="main-loader" class="loader" hidden></div>
                    </div>
                </div>
                <div id="searchResults" role="listbox" aria-label="Search Results" hidden></div>
                <div id="a11y-announcer" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>
            </div>
            <div id="detailsSection">
            </div>
        </main>
    </div>
    <div id="trailer-modal">
        <div class="trailer-container">
            <iframe id="trailer-iframe" allow="autoplay; fullscreen" allowfullscreen></iframe>
            <button id="close-trailer-btn" aria-label="Close trailer">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>
    <div id="poster-modal">
        <div class="poster-modal-content">
            <img id="full-poster-img" alt="Full-size poster">
            <button id="close-poster-btn" aria-label="Close poster view">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>
    <div id="toast-notification"></div>
    <script>
        (() => {
            const CONFIG = {
                apiKey: "c674a42c1610c3dc031b925860214289",
                debounceDelay: 200,
                imgBaseUrl: 'https://image.tmdb.org/t/p/',
                imageSizes: {
                    thumbnail: 'w92',
                    poster: 'w342',
                    original: 'original'
                },
                mediaTypes: {
                    movie: 'movie',
                    tv: 'tv',
                },
                copyTypes: {
                    names: 'names',
                    rename: 'rename'
                },
                placeholderImg: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 2 3' fill='%231f2937'%3E%3Crect width='2' height='3'/%3E%3C/svg%3E"
            };
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const detailsSection = document.getElementById('detailsSection');
            const mainLoader = document.getElementById('main-loader');
            const titleButton = document.getElementById('title-button');
            const announcer = document.getElementById('a11y-announcer');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            const trailerModal = document.getElementById('trailer-modal');
            const trailerIframe = document.getElementById('trailer-iframe');
            const posterModal = document.getElementById('poster-modal');
            const fullPosterImg = document.getElementById('full-poster-img');
            const toastNotification = document.getElementById('toast-notification');
            const state = {
                debounceTimer: null,
                currentKeyboardFocus: -1,
                toastTimer: null
            };
            let searchResultNodes = [];
            const copyIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a2.25 2.25 0 01-2.25 2.25H9.75A2.25 2.25 0 017.5 4.5v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>`;
            const checkIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>`;
            const errorIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
            const playIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.647c1.295.748 1.295 2.539 0 3.286L7.279 20.99c-1.25.72-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" /></svg>`;
            const fetchData = async (url) => {
                mainLoader.hidden = false;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    return await response.json();
                } catch (error) {
                    console.error("Fetch failed:", error);
                    return {
                        error: "Failed to fetch data. Please check your connection or try again later."
                    };
                } finally {
                    mainLoader.hidden = true;
                }
            };
            const clearAndDisplayError = (container, message) => {
                container.innerHTML = `<div class="error-message">${message}</div>`;
            };
            const searchMedia = (query) => {
                if (!query) return clearSearchResults();
                const url = `https://api.themoviedb.org/3/search/multi?api_key=${CONFIG.apiKey}&language=en-US&query=${encodeURIComponent(query)}`;
                fetchData(url).then(data => {
                    if (data.error) return clearAndDisplayError(searchResults, data.error);
                    if (data && data.results) displaySearchResults(data.results);
                });
            };
            const getMediaDetails = async (id, type) => {
                clearSearchResults();
                detailsSection.innerHTML = `<div class="episode-loader" style="padding: 4rem 0;"><div class="loader"></div></div>`;
                const detailsUrl = `https://api.themoviedb.org/3/${type}/${id}?api_key=${CONFIG.apiKey}&language=en-US`;
                const creditsUrl = `https://api.themoviedb.org/3/${type}/${id}/credits?api_key=${CONFIG.apiKey}&language=en-US`;
                const [details, credits] = await Promise.all([
                    fetchData(detailsUrl),
                    fetchData(creditsUrl)
                ]);
                if (details.error || credits.error) {
                    return clearAndDisplayError(detailsSection, details.error || credits.error);
                }
                if (details) {
                    if (type === CONFIG.mediaTypes.movie) {
                        displayMovieDetails(details, credits);
                        detailsSection.querySelector('.copy-btn')?.focus();
                    } else {
                        displayTvShowDetails(details, credits);
                        detailsSection.querySelector('#season-select')?.focus();
                    }
                }
            };
            const getSeasonDetails = (tvId, seasonNumber) => {
                const url = `https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${CONFIG.apiKey}&language=en-US`;
                const episodeListContainer = document.querySelector('.episode-list');
                const copyAllBtn = document.getElementById('copy-all-toggle-btn');
                const seasonSelect = document.getElementById('season-select');
                if (episodeListContainer) episodeListContainer.innerHTML = `<div class="episode-loader"><div class="loader"></div></div>`;
                if (copyAllBtn) copyAllBtn.disabled = true;
                fetchData(url).then(data => {
                    if (data.error) return clearAndDisplayError(episodeListContainer, data.error);
                    if (data && data.episodes && episodeListContainer) {
                        displayEpisodes(data.episodes);
                        updateCopyAllData(data.episodes);
                        const selectedSeasonName = seasonSelect.options[seasonSelect.selectedIndex].text;
                        announcer.textContent = `Loaded ${data.episodes.length} episodes for ${selectedSeasonName}.`;
                    }
                });
            };
            const sanitizeText = (text) => {
                const temp = document.createElement('div');
                temp.textContent = text || '';
                return temp.innerHTML;
            };
            const closeSearchOnClickOutside = (e) => {
                if (!searchResults.hidden && !searchResults.contains(e.target) && e.target !== searchInput) {
                    clearSearchResults();
                }
            };
            const clearSearchResults = () => {
                searchResults.innerHTML = '';
                searchResults.hidden = true;
                state.currentKeyboardFocus = -1;
                searchResultNodes = [];
                searchInput.removeAttribute('aria-activedescendant');
                document.removeEventListener('click', closeSearchOnClickOutside);
            };
            const createPosterHTML = (posterPath, altText, size = 'thumbnail') => {
                const posterUrl = posterPath ? `${CONFIG.imgBaseUrl}${CONFIG.imageSizes[size]}${posterPath}` : CONFIG.placeholderImg;
                return `
                    <div class="poster-container">
                        <img class="poster-image" data-poster-path="${posterPath}" src="${posterUrl}" alt="${altText}" loading="lazy" onerror="this.onerror=null;this.src='${CONFIG.placeholderImg}';">
                        <div class="play-overlay">
                            <button type="button" class="play-trailer-btn" aria-label="Watch trailer for ${altText}">${playIconSVG}</button>
                        </div>
                    </div>`;
            };
            const displaySearchResults = (results) => {
                clearSearchResults();
                const filteredResults = results.filter(r => r.media_type === CONFIG.mediaTypes.movie || r.media_type === CONFIG.mediaTypes.tv);
                if (filteredResults.length === 0) {
                    searchResults.innerHTML = `<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg><p style="font-weight: 600;">No results found</p><p style="font-size: 0.875rem; color: var(--tertiary-text); margin-top: 0.25rem;">We couldn't find anything for your search.</p></div>`;
                    announcer.textContent = 'No results found.';
                } else {
                    const fragment = document.createDocumentFragment();
                    filteredResults.forEach((result, index) => {
                        const item = document.createElement('div');
                        item.className = 'search-result-item';
                        item.dataset.id = result.id;
                        item.dataset.type = result.media_type;
                        item.id = `result-option-${index}`;
                        item.setAttribute('role', 'option');
                        const year = result.release_date?.split('-')[0] || result.first_air_date?.split('-')[0] || 'N/A';
                        const title = result.title || result.name;
                        const sanitizedTitle = sanitizeText(title);
                        item.innerHTML = `
                            ${createPosterHTML(result.poster_path, `Poster for ${sanitizedTitle}`)}
                            <div class="info">
                                <p class="title">${sanitizedTitle}</p>
                                <p class="meta">${year} &bull; ${result.media_type.toUpperCase()}</p>
                            </div>`;
                        fragment.appendChild(item);
                    });
                    searchResults.appendChild(fragment);
                    searchResultNodes = searchResults.querySelectorAll('.search-result-item');
                    announcer.textContent = `${filteredResults.length} results found. Use arrow keys to navigate.`;
                    document.addEventListener('click', closeSearchOnClickOutside);
                }
                searchResults.hidden = false;
            };
            const createNameBlock = (name) => `<div class="name-block"><div class="name-line"><pre>${sanitizeText(name)}</pre><button class="copy-btn" data-copy-text="${sanitizeText(name)}" aria-label="Copy title">${copyIconSVG}</button></div></div>`;
            const createAboutDetail = (label, value) => value ? `<div><strong>${label}</strong><span>${value}</span></div>` : '';
            const displayMovieDetails = (movie, credits) => {
                const title = movie.title || movie.original_title;
                const sanitizedTitle = sanitizeText(title);
                const posterHTML = createPosterHTML(movie.poster_path, `Poster for ${sanitizedTitle}`, 'poster');
                const releaseDate = movie.release_date ? new Date(movie.release_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : 'N/A';
                const language = movie.original_language ? new Intl.DisplayNames(['en'], {
                    type: 'language'
                }).of(movie.original_language) : 'N/A';
                const rating = movie.vote_count > 0 ? `${movie.vote_average.toFixed(1)} / 10 (${movie.vote_count.toLocaleString()} votes)` : 'N/A';
                const genres = movie.genres.map(g => g.name).join(', ');
                const cast = credits.cast.slice(0, 6).map(c => c.name).join(', ');
                detailsSection.innerHTML = `
                    <div class="details-header" data-id="${movie.id}" data-type="movie">
                        ${posterHTML}
                        <div class="details-info">
                            ${createNameBlock(title)}
                            ${movie.overview ? `<p class="details-overview">${sanitizeText(movie.overview)}</p>` : ''}
                        </div>
                    </div>
                    <div class="about-section">
                        <h2>About the Movie</h2>
                        <div class="about-grid">
                            ${createAboutDetail('Status', movie.status)}
                            ${createAboutDetail('Release Date', releaseDate)}
                            ${createAboutDetail('Genre', genres)}
                            ${createAboutDetail('Language', language)}
                            ${createAboutDetail('Rating', rating)}
                            ${createAboutDetail('Cast', cast)}
                        </div>
                    </div>
                `;
                appendDownloadSection(movie, CONFIG.mediaTypes.movie);
            };
            const displayTvShowDetails = (tvShow, credits) => {
                const title = tvShow.name || tvShow.original_name;
                const sanitizedTitle = sanitizeText(title);
                const posterHTML = createPosterHTML(tvShow.poster_path, `Poster for ${sanitizedTitle}`, 'poster');
                const firstAirDate = tvShow.first_air_date ? new Date(tvShow.first_air_date).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : 'N/A';
                const language = tvShow.original_language ? new Intl.DisplayNames(['en'], {
                    type: 'language'
                }).of(tvShow.original_language) : 'N/A';
                const rating = tvShow.vote_count > 0 ? `${tvShow.vote_average.toFixed(1)} / 10 (${tvShow.vote_count.toLocaleString()} votes)` : 'N/A';
                const genres = tvShow.genres.map(g => g.name).join(', ');
                const cast = credits.cast.slice(0, 6).map(c => c.name).join(', ');
                const createdBy = tvShow.created_by.map(c => c.name).join(', ');
                const sortedSeasons = tvShow.seasons.sort((a, b) => a.season_number - b.season_number);
                const seasonOptions = sortedSeasons.map(season => `<option value="${season.season_number}">${sanitizeText(season.name)}</option>`).join('');
                detailsSection.innerHTML = `
                    <div class="details-header" data-id="${tvShow.id}" data-type="tv">
                        ${posterHTML}
                        <div class="details-info">
                            ${createNameBlock(title)}
                             ${tvShow.overview ? `<p class="details-overview">${sanitizeText(tvShow.overview)}</p>` : ''}
                        </div>
                    </div>
                    <div class="season-controls">
                        <label for="season-select" class="visually-hidden">Select a Season</label>
                        <select id="season-select" data-tv-id="${tvShow.id}" aria-label="Select a season">${seasonOptions}</select>
                        <div class="copy-container">
                            <button id="copy-all-toggle-btn" class="copy-all-btn" disabled>
                                <span class="btn-text">Copy All</span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 011.06 0L10 11.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 9.28a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg>
                            </button>
                            <div id="copy-options" class="copy-options" hidden>
                                <button class="copy-option" data-copy-type="names"><span>Names Only</span></button>
                                <div class="copy-option-submenu-container">
                                    <button class="copy-option" aria-haspopup="true" aria-expanded="false">
                                        <span>Bulk Rename</span>
                                        <svg class="submenu-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div class="copy-options-level2">
                                        <button class="copy-option" data-copy-type="rename" data-extension="mkv"><span>MKV</span></button>
                                        <button class="copy-option" data-copy-type="rename" data-extension="mp4"><span>MP4</span></button>
                                        <button class="copy-option" data-copy-type="rename" data-extension="mov"><span>MOV</span></button>
                                        <button class="copy-option" data-copy-type="rename" data-extension="avi"><span>AVI</span></button>
                                        <button class="copy-option" data-copy-type="rename" data-extension="wmv"><span>WMV</span></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="episode-list" tabindex="-1"></div>
                    <div class="about-section">
                        <h2>About the Show</h2>
                        <div class="about-grid">
                            ${createAboutDetail('Status', tvShow.status)}
                            ${createAboutDetail('First Aired', firstAirDate)}
                            ${createAboutDetail('Seasons', tvShow.number_of_seasons)}
                            ${createAboutDetail('Episodes', tvShow.number_of_episodes)}
                            ${createAboutDetail('Genre', genres)}
                            ${createAboutDetail('Language', language)}
                            ${createAboutDetail('Rating', rating)}
                            ${createAboutDetail('Cast', cast)}
                            ${createAboutDetail('Created By', createdBy)}
                        </div>
                    </div>
                `;
                if (sortedSeasons.length > 0) getSeasonDetails(tvShow.id, sortedSeasons[0].season_number);
                appendDownloadSection(tvShow, CONFIG.mediaTypes.tv);
            };
            const appendDownloadSection = (details, type) => {
                const title = details.title || details.name;
                const year = (details.release_date || details.first_air_date)?.split('-')[0];
                if (!title || !year) return;
                const query = `${title} ${year}`;
                const queryEncoded = encodeURIComponent(query);
                const queryPlus = query.replace(/ /g, '+');
                const category1337x = type === 'movie' ? 'Movies' : 'TV';
                const url1337x = `https://1337x.to/sort-category-search/${queryEncoded}/${category1337x}/size/desc/1/`;
                const urlTpb = `https://thepiratebay.org/search.php?q=${queryPlus}&video=on&search=Pirate+Search&page=0&orderby=`;
                const urlYts = `https://yts.mx/browse-movies/${queryEncoded}/all/all/0/latest/0/all`;
                let optionsHTML = `
                    <div class="download-option">
                        <a href="${url1337x}" target="_blank" rel="noopener noreferrer">1337X</a>
                        <button class="copy-btn" data-copy-text="${url1337x}" aria-label="Copy 1337X link">${copyIconSVG}</button>
                    </div>
                    <div class="download-option">
                        <a href="${urlTpb}" target="_blank" rel="noopener noreferrer">TPB</a>
                        <button class="copy-btn" data-copy-text="${urlTpb}" aria-label="Copy TPB link">${copyIconSVG}</button>
                    </div>
                `;
                if (type === 'movie') {
                    optionsHTML += `
                        <div class="download-option">
                            <a href="${urlYts}" target="_blank" rel="noopener noreferrer">YTS</a>
                            <button class="copy-btn" data-copy-text="${urlYts}" aria-label="Copy YTS link">${copyIconSVG}</button>
                        </div>
                    `;
                }
                const downloadSectionHTML = `
                    <div id="download-section">
                        <button id="download-toggle-btn">
                            <span>Download</span>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 011.06 0L10 11.94l3.72-3.72a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 9.28a.75.75 0 010-1.06z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="download-options" hidden>${optionsHTML}</div>
                    </div>`;
                detailsSection.insertAdjacentHTML('beforeend', downloadSectionHTML);
            };
            const displayEpisodes = (episodes) => {
                const episodeListContainer = document.querySelector('.episode-list');
                if (!episodeListContainer) return;
                episodeListContainer.innerHTML = '';
                if (episodes.length === 0) {
                    episodeListContainer.innerHTML = `<p style="color: var(--secondary-text); text-align: center; padding: 1rem;">No episode data available for this season.</p>`;
                    return;
                }
                const fragment = document.createDocumentFragment();
                episodes.forEach(episode => {
                    const item = document.createElement('div');
                    item.className = 'episode-item';
                    item.innerHTML = `<div class="episode-content"><p class="episode-meta">EPISODE ${episode.episode_number}</p><pre>${sanitizeText(episode.name)}</pre></div><button class="copy-btn" data-copy-text="${sanitizeText(episode.name)}" aria-label="Copy episode name">${copyIconSVG}</button>`;
                    fragment.appendChild(item);
                });
                episodeListContainer.appendChild(fragment);
            };
            const updateCopyAllData = (episodes) => {
                const copyAllBtn = document.getElementById('copy-all-toggle-btn');
                const copyContainer = document.querySelector('.copy-container');
                if (!copyAllBtn || !copyContainer || episodes.length === 0) return;
                const namesOnly = episodes.map(e => e.name).join('\n');
                const relevantEpisodeData = episodes.map(e => ({
                    name: e.name,
                    episode_number: e.episode_number
                }));
                copyContainer.dataset.episodesJson = JSON.stringify(relevantEpisodeData);
                copyContainer.dataset.copyNames = namesOnly;
                copyAllBtn.disabled = false;
            };
            const handleCopyClick = async (btn, textToCopy) => {
                if (!textToCopy || btn.disabled) return;
                const originalContentHTML = btn.innerHTML;
                const feedbackDuration = 1200;
                const performCopy = async () => {
                    try {
                        await navigator.clipboard.writeText(textToCopy);
                        return true;
                    } catch (err) {
                        try {
                            const textArea = document.createElement("textarea");
                            textArea.value = textToCopy;
                            textArea.style.position = "fixed";
                            textArea.style.left = "-9999px";
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            const success = document.execCommand('copy');
                            document.body.removeChild(textArea);
                            if (!success) throw new Error('Fallback copy failed');
                            return true;
                        } catch (fallbackErr) {
                            console.error('All copy methods failed:', fallbackErr);
                            return false;
                        }
                    }
                };
                btn.disabled = true;
                const wasCopied = await performCopy();
                if (wasCopied) {
                    btn.innerHTML = checkIconSVG;
                    btn.classList.add('copied');
                } else {
                    btn.innerHTML = errorIconSVG;
                    btn.classList.add('error');
                }
                setTimeout(() => {
                    btn.innerHTML = originalContentHTML;
                    btn.classList.remove('copied', 'error');
                    btn.disabled = false;
                }, feedbackDuration);
            };
            const showToast = (message) => {
                clearTimeout(state.toastTimer);
                toastNotification.textContent = message;
                toastNotification.classList.add('visible');
                state.toastTimer = setTimeout(() => {
                    toastNotification.classList.remove('visible');
                }, 3000);
            };
            const fetchAndPlayTrailer = async (mediaId, mediaType) => {
                const url = `https://api.themoviedb.org/3/${mediaType}/${mediaId}/videos?api_key=${CONFIG.apiKey}&language=en-US`;
                const data = await fetchData(url);
                if (data.error || !data.results || data.results.length === 0) {
                    showToast('No trailer found.');
                    return;
                }
                const trailer = data.results.find(v => v.type === 'Trailer' && v.site === 'YouTube') ||
                    data.results.find(v => v.type === 'Teaser' && v.site === 'YouTube') ||
                    data.results.find(v => v.site === 'YouTube');
                if (trailer) {
                    trailerIframe.src = `https://www.youtube.com/embed/${trailer.key}?autoplay=1&rel=0`;
                    trailerModal.classList.add('visible');
                    requestAnimationFrame(() => {
                        document.getElementById('close-trailer-btn').focus();
                    });
                } else {
                    showToast('No trailer found.');
                }
            };
            const closeTrailerModal = () => {
                trailerModal.classList.remove('visible');
                trailerIframe.src = '';
            };
            const openPosterModal = (posterPath) => {
                if (!posterPath || posterPath === 'null') return;
                fullPosterImg.src = `${CONFIG.imgBaseUrl}${CONFIG.imageSizes.original}${posterPath}`;
                posterModal.classList.add('visible');
                requestAnimationFrame(() => {
                    document.getElementById('close-poster-btn').focus();
                });
            };
            const closePosterModal = () => {
                posterModal.classList.remove('visible');
                fullPosterImg.src = '';
            };
            const toTitleCase = (str) => {
                if (!str) return '';
                const minorWords = new Set(['a', 'an', 'the', 'and', 'but', 'or', 'nor', 'for', 'so', 'yet', 'as', 'at', 'by', 'in', 'of', 'off', 'on', 'to', 'up']);
                const capitalize = (word) => {
                    if (word.length > 1 && word.toUpperCase() === word) return word;
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                };
                const words = str.split(' ');
                return words.map((word, index) => {
                    if (word === "") return "";
                    const lowerWord = word.toLowerCase();
                    if (index === 0 || index === words.length - 1) return capitalize(word);
                    if (index > 0 && words[index - 1].endsWith(':')) return capitalize(word);
                    if (word.includes('-')) return word.split('-').map((part, partIndex) => {
                        if (partIndex === 0) return capitalize(part);
                        if (minorWords.has(part.toLowerCase())) return part.toLowerCase();
                        return capitalize(part);
                    }).join('-');
                    if (minorWords.has(lowerWord)) return lowerWord;
                    return capitalize(word);
                }).join(' ');
            };
            const handleCopyOptionsKeydown = (e) => {
                const activeElement = document.activeElement;
                if (!activeElement.classList.contains('copy-option')) return;
                const currentMenu = activeElement.closest('.copy-options, .copy-options-level2');
                if (!currentMenu) return;
                const options = Array.from(currentMenu.querySelectorAll(':scope > .copy-option, :scope > .copy-option-submenu-container > .copy-option'));
                const currentIndex = options.indexOf(activeElement);
                switch (e.key) {
                    case 'ArrowUp':
                    case 'ArrowDown':
                        e.preventDefault();
                        const direction = e.key === 'ArrowDown' ? 1 : -1;
                        const nextIndex = (currentIndex + direction + options.length) % options.length;
                        options[nextIndex]?.focus();
                        break;
                    case 'ArrowRight':
                        if (activeElement.parentElement.classList.contains('copy-option-submenu-container')) {
                            e.preventDefault();
                            activeElement.nextElementSibling.querySelector('.copy-option')?.focus();
                        }
                        break;
                    case 'ArrowLeft':
                        if (currentMenu.classList.contains('copy-options-level2')) {
                            e.preventDefault();
                            currentMenu.parentElement.querySelector('.copy-option')?.focus();
                        }
                        break;
                    case 'Enter':
                        if (!activeElement.parentElement.classList.contains('copy-option-submenu-container')) activeElement.click();
                        break;
                    case 'Escape':
                        e.preventDefault();
                        if (currentMenu.classList.contains('copy-options-level2')) {
                            currentMenu.parentElement.querySelector('.copy-option')?.focus();
                        } else {
                            document.getElementById('copy-options').hidden = true;
                            document.getElementById('copy-all-toggle-btn')?.focus();
                        }
                        break;
                }
            };
            const handleDropdown = (toggleBtn, optionsMenu) => {
                if (toggleBtn.classList.contains('copied') || toggleBtn.classList.contains('error')) return;
                const isHidden = optionsMenu.hidden;
                const closeMenu = () => {
                    optionsMenu.hidden = true;
                    toggleBtn.classList.remove('dropdown-open');
                    document.removeEventListener('click', handleOutsideClick);
                    if (optionsMenu.id === 'copy-options') {
                        optionsMenu.removeEventListener('keydown', handleCopyOptionsKeydown);
                    }
                };
                const handleOutsideClick = (event) => {
                    if (!toggleBtn.parentElement.contains(event.target)) {
                        closeMenu();
                    }
                };
                if (isHidden) {
                    optionsMenu.hidden = false;
                    toggleBtn.classList.add('dropdown-open');
                    setTimeout(() => document.addEventListener('click', handleOutsideClick), 0);
                    if (optionsMenu.id === 'copy-options') {
                        optionsMenu.addEventListener('keydown', handleCopyOptionsKeydown);
                    }
                } else {
                    closeMenu();
                }
            };
            searchInput.addEventListener('input', () => {
                const originalValue = searchInput.value;
                const cursorPosition = searchInput.selectionStart;
                const titleCasedValue = toTitleCase(originalValue);
                if (originalValue !== titleCasedValue) {
                    searchInput.value = titleCasedValue;
                    searchInput.setSelectionRange(cursorPosition, cursorPosition);
                }
                clearTimeout(state.debounceTimer);
                clearSearchBtn.hidden = searchInput.value.length === 0;
                if (searchInput.value.length === 0) {
                    clearSearchResults();
                    return;
                }
                state.debounceTimer = setTimeout(() => {
                    searchMedia(searchInput.value.trim());
                }, CONFIG.debounceDelay);
            });
            searchInput.addEventListener('keydown', (e) => {
                if (searchResults.hidden) return;
                if (e.key === 'Escape') return clearSearchResults();
                if (searchResultNodes.length === 0) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    state.currentKeyboardFocus = (state.currentKeyboardFocus + 1) % searchResultNodes.length;
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    state.currentKeyboardFocus = (state.currentKeyboardFocus - 1 + searchResultNodes.length) % searchResultNodes.length;
                } else if (e.key === 'Enter' && state.currentKeyboardFocus > -1) {
                    e.preventDefault();
                    searchResultNodes[state.currentKeyboardFocus].click();
                    return;
                } else {
                    return;
                }
                setActiveResult();
            });
            const setActiveResult = () => {
                searchResultNodes.forEach((item, index) => {
                    if (index === state.currentKeyboardFocus) {
                        item.classList.add('active');
                        item.scrollIntoView({
                            block: 'nearest'
                        });
                        searchInput.setAttribute('aria-activedescendant', item.id);
                    } else {
                        item.classList.remove('active');
                    }
                });
            };
            searchResults.addEventListener('click', (e) => {
                const item = e.target.closest('.search-result-item');
                if (!item) return;
                const playBtn = e.target.closest('.play-trailer-btn');
                if (playBtn) {
                    fetchAndPlayTrailer(item.dataset.id, item.dataset.type);
                    return;
                }
                const posterContainer = e.target.closest('.poster-container');
                if (posterContainer) {
                    const posterImg = posterContainer.querySelector('.poster-image');
                    openPosterModal(posterImg.dataset.posterPath);
                    return;
                }
                getMediaDetails(item.dataset.id, item.dataset.type);
            });
            detailsSection.addEventListener('click', (e) => {
                const target = e.target;
                const playBtn = target.closest('.play-trailer-btn');
                const header = target.closest('.details-header');
                if (playBtn && header) {
                    fetchAndPlayTrailer(header.dataset.id, header.dataset.type);
                    return;
                }
                const posterContainer = target.closest('.poster-container');
                if (posterContainer) {
                    const posterImg = posterContainer.querySelector('.poster-image');
                    openPosterModal(posterImg.dataset.posterPath);
                    return;
                }
                const copyBtn = target.closest('.copy-btn');
                if (copyBtn) {
                    if (copyBtn.closest('#download-options')) {
                        e.stopPropagation();
                    }
                    handleCopyClick(copyBtn, copyBtn.dataset.copyText);
                    return;
                }
                const copyAllToggleBtn = target.closest('#copy-all-toggle-btn');
                if (copyAllToggleBtn) {
                    handleDropdown(copyAllToggleBtn, document.getElementById('copy-options'));
                    return;
                }
                const downloadToggleBtn = target.closest('#download-toggle-btn');
                if (downloadToggleBtn) {
                    handleDropdown(downloadToggleBtn, document.getElementById('download-options'));
                    return;
                }
                const copyOptionBtn = target.closest('.copy-option');
                if (copyOptionBtn) {
                    if (copyOptionBtn.hasAttribute('aria-haspopup')) {
                        e.preventDefault();
                        const submenuContainer = copyOptionBtn.parentElement;
                        if (submenuContainer.classList.contains('submenu-open')) {
                            submenuContainer.classList.remove('submenu-open');
                            copyOptionBtn.setAttribute('aria-expanded', 'false');
                            copyOptionBtn.blur();
                        } else {
                            submenuContainer.classList.add('submenu-open');
                            copyOptionBtn.setAttribute('aria-expanded', 'true');
                        }
                        return;
                    }
                    const copyContainer = target.closest('.copy-container');
                    const copyType = copyOptionBtn.dataset.copyType;
                    let textToCopy;
                    if (copyType === CONFIG.copyTypes.names) {
                        textToCopy = copyContainer.dataset.copyNames;
                    } else if (copyType === CONFIG.copyTypes.rename) {
                        const extension = copyOptionBtn.dataset.extension;
                        const episodes = JSON.parse(copyContainer.dataset.episodesJson);
                        textToCopy = episodes.map(e => `E${String(e.episode_number).padStart(2, '0')} - ${e.name}.${extension}`).join('\n');
                    }
                    if (textToCopy) {
                        const copyAllBtn = document.getElementById('copy-all-toggle-btn');
                        document.getElementById('copy-options').hidden = true;
                        copyAllBtn.classList.remove('dropdown-open');
                        handleCopyClick(copyAllBtn, textToCopy);
                    }
                }
            });
            detailsSection.addEventListener('change', (e) => {
                if (e.target.id === 'season-select') {
                    getSeasonDetails(e.target.dataset.tvId, e.target.value);
                }
            });
            const clearSearchInput = () => {
                searchInput.value = '';
                clearSearchResults();
                announcer.textContent = 'Search input cleared.';
                clearSearchBtn.hidden = true;
                searchInput.focus();
            };
            const resetApp = () => {
                clearSearchInput();
                detailsSection.innerHTML = '';
            };
            clearSearchBtn.addEventListener('click', clearSearchInput);
            titleButton.addEventListener('click', resetApp);
            document.getElementById('close-trailer-btn').addEventListener('click', closeTrailerModal);
            trailerModal.addEventListener('click', (e) => {
                if (e.target === trailerModal) closeTrailerModal();
            });
            document.getElementById('close-poster-btn').addEventListener('click', closePosterModal);
            posterModal.addEventListener('click', (e) => {
                if (e.target === posterModal) closePosterModal();
            });
            window.addEventListener('keydown', (e) => {
                if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
                    e.preventDefault();
                    searchInput.classList.add('search-focus-flash');
                    searchInput.focus();
                    setTimeout(() => searchInput.classList.remove('search-focus-flash'), 500);
                }
                if (e.key === 'Escape') {
                    if (trailerModal.classList.contains('visible')) {
                        closeTrailerModal();
                        return;
                    }
                    if (posterModal.classList.contains('visible')) {
                        closePosterModal();
                        return;
                    }
                    const downloadOptions = document.getElementById('download-options');
                    if (downloadOptions && !downloadOptions.hidden) {
                        const btn = document.getElementById('download-toggle-btn');
                        downloadOptions.hidden = true;
                        btn.classList.remove('dropdown-open');
                        btn.focus();
                        return;
                    }
                    const copyOptions = document.getElementById('copy-options');
                    if (copyOptions && !copyOptions.hidden) {
                        const btn = document.getElementById('copy-all-toggle-btn');
                        const openSubmenu = copyOptions.querySelector('.submenu-open');
                        if (openSubmenu) {
                            openSubmenu.classList.remove('submenu-open');
                            openSubmenu.querySelector('[aria-haspopup]').setAttribute('aria-expanded', 'false');
                        }
                        copyOptions.hidden = true;
                        btn.classList.remove('dropdown-open');
                        btn.focus();
                        return;
                    }
                    if (!searchResults.hidden) {
                        clearSearchResults();
                    }
                }
            });
            searchInput.focus();
        })();
    </script>
</body>
</html>
